@model FSSA.Models.Proposal
@using FSSA.DTOs;

@{
    ViewData["Title"] = "Edit Proposal";
    var originalFinancial = ViewBag.OriginalFinancialResources as List<FinancialResourceDto>;
    var initialJson = ViewBag.FinancialResourcesJson as string ?? "[]";
}

<h1>Edit Proposal</h1>

<form id="proposalForm" asp-action="Edit" method="post">
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="StatusId" />

    <!-- Title -->
    <div class="mb-3 row">
        <div class="col-md-6">
            <label class="form-label">Original Title</label>
            <input class="form-control" value="@Model.Title" disabled />
        </div>
        <div class="col-md-6">
            <label class="form-label">New Title</label>
            <input asp-for="Title" class="form-control" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>
    </div>

    <!-- Synopsis -->
    <div class="mb-3 row">
        <div class="col-md-6">
            <label class="form-label">Original Synopsis</label>
            <textarea class="form-control" disabled>@Model.Synopsis</textarea>
        </div>
        <div class="col-md-6">
            <label class="form-label">New Synopsis</label>
            <textarea asp-for="Synopsis" class="form-control"></textarea>
            <span asp-validation-for="Synopsis" class="text-danger"></span>
        </div>
    </div>

    <!-- Method -->
    <div class="mb-3 row">
        <div class="col-md-6">
            <label class="form-label">Original Method</label>
            <textarea class="form-control" disabled>@Model.Method</textarea>
        </div>
        <div class="col-md-6">
            <label class="form-label">New Method</label>
            <textarea asp-for="Method" class="form-control"></textarea>
            <span asp-validation-for="Method" class="text-danger"></span>
        </div>
    </div>

    <!-- Project Level -->
    <div class="mb-3 row">
        <div class="col-md-6">
            <label class="form-label">Original Project Level</label>
            <input class="form-control" value="@ViewBag.CurrentLevelName" disabled />
        </div>
        <div class="col-md-6">
            <label class="form-label">New Project Level</label>
            <select asp-for="ProjectLevelId" class="form-select" asp-items="ViewBag.ProjectLevels">
                <option value="">-- Pick a Project Level --</option>
            </select>
            <span asp-validation-for="ProjectLevelId" class="text-danger"></span>
        </div>
    </div>

    <!-- Physical Resources -->
    <div class="mb-3 row">
        <div class="col-md-6">
            <label class="form-label">Original Physical Resources</label>
            <textarea class="form-control" disabled>@Model.PhysicalResources</textarea>
        </div>
        <div class="col-md-6">
            <label class="form-label">New Physical Resources</label>
            <textarea asp-for="PhysicalResources" class="form-control"></textarea>
            <span asp-validation-for="PhysicalResources" class="text-danger"></span>
        </div>
    </div>

    <!-- Financial Resources -->
    <div class="mb-3 row">
        <div class="col-md-6">
            <label class="form-label">Original Financial Resources</label>
            <ul class="list-group">
                @foreach (var item in originalFinancial ?? new List<FinancialResourceDto>())
                {
                    <li class="list-group-item d-flex justify-content-between">
                        <span>@item.Title</span>
                        <span>$@item.Cost.ToString("F2")</span>
                    </li>
                }
            </ul>
        </div>
        <div class="col-md-6">
            <label class="form-label">New Financial Resources</label>
            <button type="button" class="btn btn-outline-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#financialModal">Edit Financial Resources</button>
            <input type="hidden" name="FinancialResourcesJson" id="FinancialResourcesJson" value='@initialJson' />
            <div id="financialResourcesList" class="border p-2 bg-light"></div>
        </div>
    </div>

    <!-- Confirmation -->
    <button type="button" class="btn btn-warning mb-3" id="triggerModalBtn">Modify Proposal</button>
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Edit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>You Are Rewriting An Existing Proposal. Publish?</p>
                    <div class="alert alert-warning">NOTE: These Changes Will Be Broadcasted to the Dashboard!</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Yes, Publish My Changes.</button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Financial Modal -->
<div class="modal fade" id="financialModal" tabindex="-1" aria-labelledby="financialModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title">Edit Financial Resources</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="financialInputs"></div>
                <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addFinancialEntry()">+ Add Resource</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal" onclick="saveFinancialChanges()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const jsonInput = document.getElementById("FinancialResourcesJson");
        const displayList = document.getElementById("financialResourcesList");
        const inputsDiv = document.getElementById("financialInputs");

        function renderFinancialList() {
            const data = JSON.parse(jsonInput.value || "[]");
            displayList.innerHTML = '';
            data.forEach(item => {
                const entry = document.createElement('div');
                entry.className = 'd-flex justify-content-between mb-1';
                entry.innerHTML = `<span>${item.title}</span><span>$${parseFloat(item.cost).toFixed(2)}</span>`;
                displayList.appendChild(entry);
            });
        }

        function addFinancialEntry(title = "", cost = "") {
            const wrapper = document.createElement('div');
            wrapper.className = "d-flex gap-2 mb-2";
            wrapper.innerHTML = `
                <input type="text" class="form-control" placeholder="Title" value="${title}" />
                <input type="number" class="form-control" placeholder="Cost" value="${cost}" />
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">âœ•</button>`;
            inputsDiv.appendChild(wrapper);
        }

        function saveFinancialChanges() {
            const entries = inputsDiv.querySelectorAll("div");
            const list = [];
            entries.forEach(entry => {
                const [titleInput, costInput] = entry.querySelectorAll("input");
                const title = titleInput.value.trim();
                const cost = parseFloat(costInput.value);
                if (title && !isNaN(cost)) {
                    list.push({ title, cost });
                }
            });
            jsonInput.value = JSON.stringify(list);
            renderFinancialList();
        }

        document.addEventListener("DOMContentLoaded", () => {
            renderFinancialList();
            const data = JSON.parse(jsonInput.value || "[]");
            data.forEach(entry => addFinancialEntry(entry.title, entry.cost));

            const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
            document.getElementById("triggerModalBtn").addEventListener("click", function () {
                if ($("#proposalForm").valid()) modal.show();
            });
        });
    </script>
}
