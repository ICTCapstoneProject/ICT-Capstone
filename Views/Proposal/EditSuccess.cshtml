@model FSSA.Models.Proposal

@{
    ViewData["Title"] = "Proposal Edited Successfully";

    // Human-readable old values
    var orig = ViewBag.OriginalProposal;
    var origLevel = ViewBag.OrigProjectLevelName as string ?? "N/A";
    var origLead = ViewBag.OrigLeadResearcherName as string ?? "N/A";
    var origCoResearchers = ViewBag.OrigCoResearcherNames as List<string> ?? new();
    var origFinancials = ViewBag.OrigFinancialResources as List<FSSA.Models.FinancialResource> ?? new();
    var origAttachments = ViewBag.OrigAttachments as List<FSSA.Models.Attachment> ?? new();

    // Human-readable new values
    var newLevel = ViewBag.UpdatedProjectLevelName as string ?? "N/A";
    var newLead = ViewBag.UpdatedLeadResearcherName as string ?? "N/A";
    var newCoResearchers = ViewBag.UpdatedCoResearcherNames as List<string> ?? new();
    var newFinancials = ViewBag.UpdatedFinancialResources as List<FSSA.Models.FinancialResource> ?? new();
    var newAttachments = ViewBag.UpdatedAttachments as List<FSSA.Models.Attachment> ?? new();

    string ReadableList(IEnumerable<string> items) =>
        items != null && items.Any() ? string.Join(", ", items) : "N/A";
}

<style>
    .compare-heading {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    .compare-row {
        margin-bottom: 2rem;
    }
    .side-label {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: flex-start; 
        padding: 0.8rem 1rem;
    }
    .side-box {
        background: #f8f9fa;
        border: 1px solid #e2e3e5;
        border-radius: 0.4rem;
        height: 8em;
        padding: 0.8rem 1rem;
        word-break: break-word;
        white-space: pre-line;
        font-size: 1rem;
        overflow-x: auto;
        display: flex;
        align-items: flex-start; 
    }
    .side-box-changed {
        background: #fff3cd;
        border: 1px solid #ffe69c;
    }
    .side-box ul, .side-box-changed ul {
        padding-left: 1.2em;
        margin-bottom: 0;
    }
</style>

<div class="alert alert-warning mt-3 mb-4">
    <h4 class="alert-heading">Edit Successful</h4>
    <p class="mb-0">
        Proposal <strong>@Model.Id</strong>, <em>"@Model.Title"</em> has been updated by <strong>@ViewBag.SubmitterName</strong>.
    </p>
</div>

<div class="container mb-5">
    <div class="card shadow">
        <div class="card-header">
            <span class="compare-heading">Proposal <strong>@Model.Id</strong>, <em>"@Model.Title"</em> Version Comparison</span>
        </div>
        <div class="card-body px-4 py-4">

            <!-- Title -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Title (Original)</div>
                    <div class="side-box">@((orig?.Title ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Title (Editted)</div>
                    <div class="side-box side-box-changed">@Model.Title</div>
                </div>
            </div>

            <!-- Synopsis -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Synopsis (Original)</div>
                    <div class="side-box">@((orig?.Synopsis ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Synopsis (Editted)</div>
                    <div class="side-box side-box-changed">@Model.Synopsis</div>
                </div>
            </div>

            <!-- Method -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Method (Original)</div>
                    <div class="side-box">@((orig?.Method ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Method (Editted)</div>
                    <div class="side-box side-box-changed">@Model.Method</div>
                </div>
            </div>

            <!-- Project Level -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Project Level (Original)</div>
                    <div class="side-box">@origLevel</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Project Level (Editted)</div>
                    <div class="side-box side-box-changed">@newLevel</div>
                </div>
            </div>

            <!-- Lead Researcher -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Lead Researcher (Original)</div>
                    <div class="side-box">@origLead</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Lead Researcher (Editted)</div>
                    <div class="side-box side-box-changed">@newLead</div>
                </div>
            </div>

            <!-- Co-Researchers -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Co-Researchers (Original)</div>
                    <div class="side-box">@ReadableList(origCoResearchers)</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Co-Researchers (Editted)</div>
                    <div class="side-box side-box-changed">@ReadableList(newCoResearchers)</div>
                </div>
            </div>

            <!-- Physical Resources -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Physical Resources (Original)</div>
                    <div class="side-box">@((orig?.PhysicalResources ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Physical Resources (Editted)</div>
                    <div class="side-box side-box-changed">@Model.PhysicalResources</div>
                </div>
            </div>

            <!-- Financial Resources -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Financial Resources (Original)</div>
                    <div class="side-box">
                        @if (origFinancials.Any())
                        {
                            <ul>
                                @foreach (var fr in origFinancials)
                                {
                                    <li>@fr.Title <span class="text-muted">- $@($"{fr.Cost:0.00}")</span></li>
                                }
                            </ul>
                        }
                        else { <span>N/A</span>; }
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Financial Resources (Editted)</div>
                    <div class="side-box side-box-changed">
                        @if (newFinancials.Any())
                        {
                            <ul>
                                @foreach (var fr in newFinancials)
                                {
                                    <li>@fr.Title <span class="text-muted">- $@($"{fr.Cost:0.00}")</span></li>
                                }
                            </ul>
                        }
                        else { <span>N/A</span>; }
                    </div>
                </div>
            </div>

            <!-- Ethical Considerations -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Ethical Considerations (Original)</div>
                    <div class="side-box">@((orig?.EthicalConsiderations ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Ethical Considerations (Editted)</div>
                    <div class="side-box side-box-changed">@Model.EthicalConsiderations</div>
                </div>
            </div>

            <!-- Outcomes -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Outcomes (Original)</div>
                    <div class="side-box">@((orig?.Outcomes ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Outcomes (Editted)</div>
                    <div class="side-box side-box-changed">@Model.Outcomes</div>
                </div>
            </div>

            <!-- Milestones -->
            <div class="row compare-row">
                <div class="col-md-6">
                    <div class="side-label">Milestones (Original)</div>
                    <div class="side-box">@((orig?.Milestones ?? "—"))</div>
                </div>
                <div class="col-md-6">
                    <div class="side-label">Milestones (Editted)</div>
                    <div class="side-box side-box-changed">@Model.Milestones</div>
                </div>
            </div>

            <!-- Estimated Completion -->
          <div class="row compare-row">
            <div class="col-md-6">
                <div class="side-label">Estimated Completion (Original)</div>
                <div class="side-box">
                    @(
                        orig != null && orig.EstimatedCompletionDate != DateTime.MinValue
                            ? orig.EstimatedCompletionDate.ToString("yyyy-MM-dd")
                            : "—"
                    )
                </div>
            </div>
            <div class="col-md-6">
                <div class="side-label">Estimated Completion (Edited)</div>
                <div class="side-box side-box-changed">
                    @Model.EstimatedCompletionDate.ToString("yyyy-MM-dd")
                </div>
            </div>
        </div>
            <!-- Attachments -->
<div class="row compare-row">
    <div class="col-md-6">
        <div class="side-label">Attachments (Original)</div>
        <div class="side-box">
            @if (origAttachments.Any())
            {
                <ul class="list-unstyled mb-0">
                    @foreach (var att in origAttachments)
                    {
                       <li class="d-flex align-items-center gap-2 mb-2" style="min-height:36px;">
                            <a href="@att.FileUrl" download class="btn btn-outline-success btn-sm d-flex align-items-center justify-content-center p-0" title="Download" style="width:2rem; height:2rem;">
                                <i class="bi bi-download" style="font-size:1.1rem;"></i>
                            </a>
                            <span class="ms-2 flex-grow-1" style="font-weight:500; line-height:1.4;">@att.FileName</span>
                        </li>
                                            }
                    </ul>
            }
            else
            {
                <span>N/A</span>
            }
        </div>
    </div>
    <div class="col-md-6">
        <div class="side-label">Attachments (Edited)</div>
        <div class="side-box side-box-changed">
            @if (newAttachments.Any())
            {
                <ul class="list-unstyled mb-0">
                @foreach (var att in newAttachments)
                {
                    <li class="d-flex align-items-center gap-2 mb-2" style="min-height:36px;">
                        <a href="@att.FileUrl" download class="btn btn-outline-success btn-sm d-flex align-items-center justify-content-center p-0" title="Download" style="width:2rem; height:2rem;">
                            <i class="bi bi-download" style="font-size:1.1rem;"></i>
                        </a>
                        <span class="ms-2 flex-grow-1" style="font-weight:500; line-height:1.4;">@att.FileName</span>
                    </li>
                }
                </ul>
            }
            else
            {
                <span>N/A</span>
            }
        </div>
    </div>
</div>

<a class="btn btn-primary mt-3 mb-2" href="@Url.Action("Search")">Back to Proposals</a>
